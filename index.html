<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Guess the Animal</title>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; overflow-x: hidden; }
    .bg-gradient { min-height: 100vh; background: linear-gradient(135deg, #34d399 0%, #3b82f6 50%, #a855f7 100%); display: flex; align-items: center; justify-content: center; padding: 0.5rem; }
    .card { background: white; border-radius: 1.5rem; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); padding: 2rem; max-width: 28rem; width: 100%; }
    .card-lg { max-width: 64rem; width: 100%; }
    @media (max-width: 768px) {
      .bg-gradient { padding: 0.25rem; }
      .card, .card-lg { padding: 0.75rem; max-width: 100%; margin: 0; border-radius: 1rem; }
      h1 { font-size: 1.5rem !important; }
      h2 { font-size: 1.25rem !important; }
    }
    .text-center { text-align: center; }
    .mb-2 { margin-bottom: 0.5rem; }
    .mb-4 { margin-bottom: 1rem; }
    .mb-6 { margin-bottom: 1.5rem; }
    .mb-8 { margin-bottom: 2rem; }
    h1 { font-size: 2.25rem; font-weight: bold; color: #1f2937; }
    h2 { font-size: 1.875rem; font-weight: bold; color: #1f2937; }
    .text-gray { color: #6b7280; }
    .text-xl { font-size: 1.25rem; }
    @media (max-width: 768px) {
      .text-xl { font-size: 1rem; }
    }
    input { width: 100%; padding: 0.75rem 1rem; border: 2px solid #d1d5db; border-radius: 0.5rem; font-size: 1.125rem; outline: none; }
    input:focus { border-color: #3b82f6; }
    button { width: 100%; padding: 1rem 1.5rem; font-weight: bold; border-radius: 0.5rem; border: none; cursor: pointer; transition: all 0.2s; font-size: 1rem; }
    @media (max-width: 768px) {
      button { padding: 0.75rem 1rem; font-size: 0.875rem; }
    }
    button:disabled { background: #d1d5db; cursor: not-allowed; }
    .btn-purple { background: #a855f7; color: white; }
    .btn-purple:hover:not(:disabled) { background: #9333ea; }
    .btn-blue { background: #3b82f6; color: white; }
    .btn-blue:hover { background: #2563eb; }
    .player-card { background: #f3f4f6; border-radius: 0.5rem; padding: 1rem; display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem; flex-wrap: wrap; }
    @media (max-width: 768px) {
      .player-card { padding: 0.5rem; gap: 0.5rem; }
    }
    .avatar { width: 2.5rem; height: 2.5rem; background: #3b82f6; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; flex-shrink: 0; }
    @media (max-width: 768px) {
      .avatar { width: 2rem; height: 2rem; font-size: 0.875rem; }
    }
    .badge { font-size: 0.75rem; padding: 0.25rem 0.5rem; border-radius: 0.25rem; white-space: nowrap; }
    .badge-purple { background: #e9d5ff; color: #7e22ce; }
    .badge-green { background: #bbf7d0; color: #15803d; }
    .animate-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
    .game-header { background: white; border-radius: 1rem; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); padding: 1.5rem; margin-bottom: 1rem; }
    @media (max-width: 768px) {
      .game-header { padding: 0.75rem; margin-bottom: 0.5rem; }
    }
    .score-box { text-align: center; background: #f9fafb; border-radius: 0.5rem; padding: 0.5rem 0.75rem; min-width: 60px; }
    @media (max-width: 768px) {
      .score-box { padding: 0.25rem 0.5rem; min-width: 50px; }
    }
    .score-name { font-size: 0.75rem; color: #6b7280; }
    .score-value { font-size: 1.25rem; font-weight: bold; color: #3b82f6; }
    @media (max-width: 768px) {
      .score-name { font-size: 0.625rem; }
      .score-value { font-size: 1rem; }
    }
    .sound-box { background: #fef3c7; border: 4px solid #fbbf24; border-radius: 0.75rem; padding: 1.5rem; text-align: center; margin-bottom: 1rem; }
    @media (max-width: 768px) {
      .sound-box { padding: 0.75rem; border: 2px solid #fbbf24; }
    }
    .timer { font-size: 2.25rem; font-weight: bold; color: #ef4444; }
    @media (max-width: 768px) {
      .timer { font-size: 1.5rem; }
    }
    .winner-box { background: #dcfce7; border: 2px solid #22c55e; border-radius: 0.5rem; padding: 0.75rem; text-align: center; margin-bottom: 1rem; color: #15803d; font-weight: bold; }
    @media (max-width: 768px) {
      .winner-box { padding: 0.5rem; font-size: 0.875rem; }
    }
    .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; }
    @media (max-width: 768px) {
      .grid { gap: 0.5rem; }
    }
    .emoji-btn { background: white; border-radius: 0.75rem; padding: 2rem; font-size: 4rem; cursor: pointer; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); transition: transform 0.2s; border: none; }
    @media (max-width: 768px) {
      .emoji-btn { padding: 0.75rem; font-size: 2rem; border-radius: 0.5rem; }
    }
    .emoji-btn:hover:not(:disabled) { transform: scale(1.05); }
    .emoji-btn:disabled { cursor: not-allowed; }
    .emoji-correct { box-shadow: 0 0 0 4px #22c55e; background: #dcfce7; }
    .emoji-wrong { opacity: 0.5; }
    .result-item { background: #f3f4f6; border-radius: 0.5rem; padding: 1rem; display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.75rem; }
    @media (max-width: 768px) {
      .result-item { padding: 0.5rem; }
    }
    .result-rank { font-size: 1.5rem; font-weight: bold; color: #6b7280; margin-right: 0.75rem; }
    .result-score { font-size: 1.5rem; font-weight: bold; color: #3b82f6; }
    @media (max-width: 768px) {
      .result-rank, .result-score { font-size: 1.125rem; }
    }
    .trophy { font-size: 4rem; }
    @media (max-width: 768px) {
      .trophy { font-size: 2.5rem; }
    }
    .flex { display: flex; }
    .gap-3 { gap: 0.75rem; }
    @media (max-width: 768px) {
      .gap-3 { gap: 0.5rem; }
    }
    .flex-wrap { flex-wrap: wrap; }
    .justify-between { justify-content: space-between; }
    .items-center { align-items: center; }
  </style>
</head>
<body>
  <div id="app"></div>
  
  <script>
    const FIREBASE_CONFIG = {
      apiKey: "AIzaSyApv5F-IZHODQdRTC4mhRyn8tucQ7-nbMc",
      authDomain: "guess-the-animal-6bb41.firebaseapp.com",
      databaseURL: "https://guess-the-animal-6bb41-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "guess-the-animal-6bb41",
      storageBucket: "guess-the-animal-6bb41.firebasestorage.app",
      messagingSenderId: "1075279371321",
      appId: "1:1075279371321:web:2281f625f4352f6c7281e8"
    };
    
    let firebaseApp, database;
    try {
      firebaseApp = firebase.initializeApp(FIREBASE_CONFIG);
      database = firebase.database();
      console.log('Firebase initialized successfully');
    } catch (error) {
      console.error('Firebase init error:', error);
    }

    const ANIMALS = [
      { name: 'Lion', emoji: '🦁', sound: './lion.wav', options: ['🦁', '🐯', '🐻', '🐺', '🦊', '🐱'] },
      { name: 'Elephant', emoji: '🐘', sound: './elephant.wav', options: ['🐘', '🦏', '🦛', '🦒', '🐪', '🐃'] },
      { name: 'Dog', emoji: '🐕', sound: './dog.wav', options: ['🐕', '🐺', '🦊', '🐱', '🦝', '🐹'] },
      { name: 'Cat', emoji: '🐱', sound: './cat.wav', options: ['🐱', '🦁', '🐯', '🐆', '🐕', '🦊'] },
      { name: 'Cow', emoji: '🐄', sound: './cow.wav', options: ['🐄', '🐃', '🐂', '🐎', '🐏', '🐐'] },
      { name: 'Rooster', emoji: '🐓', sound: './rooster.wav', options: ['🐓', '🦃', '🦆', '🦅', '🦉', '🐦'] },
      { name: 'Frog', emoji: '🐸', sound: './frog.wav', options: ['🐸', '🐊', '🦎', '🐢', '🐍', '🦖'] },
      { name: 'Owl', emoji: '🦉', sound: './owl.wav', options: ['🦉', '🦅', '🦆', '🐦', '🦜', '🐓'] },
      { name: 'Horse', emoji: '🐎', sound: './horse.wav', options: ['🐎', '🦓', '🦌', '🐄', '🦙', '🐫'] },
      { name: 'Monkey', emoji: '🐵', sound: './monkey.wav', options: ['🐵', '🦍', '🦧', '🐻', '🦝', '🐨'] }
    ];

    function shuffleArray(array) {
      const shuffled = [...array];
      for (let i = shuffled.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
      }
      return shuffled;
    }

    function getShuffledOptions(questionIndex) {
      return shuffleArray(ANIMALS[questionIndex].options);
    }

    function generateRoomCode() {
      return Math.random().toString(36).substring(2, 8).toUpperCase();
    }

    let state = {
      screen: 'menu',
      gameMode: null,
      playerName: '',
      players: [],
      currentQuestion: 0,
      timeLeft: 5,
      scores: {},
      answered: false,
      correctAnswer: null,
      winner: null,
      myPlayerId: '',
      timer: null,
      roomCode: '',
      isHost: false,
      shuffledOptions: []
    };

    function render() {
      const app = document.getElementById('app');
      
      if (state.screen === 'menu') {
        app.innerHTML = `
          <div class="bg-gradient">
            <div class="card">
              <div class="text-center mb-8">
                <h1 class="mb-2">🎮 Guess the Animal</h1>
                <p class="text-gray">Multiplayer Sound Game</p>
              </div>
              <div class="mb-6">
                <input type="text" id="nameInput" placeholder="Enter your name" maxlength="20">
              </div>
              <div class="mb-4">
                <h3 style="font-size: 1.125rem; font-weight: 600; color: #374151; margin-bottom: 0.75rem;">Choose Game Mode:</h3>
                <button id="aiBtn" class="btn-purple mb-4" disabled style="margin-bottom: 0.75rem;">
                  🤖 Play with AI
                  <div style="font-size: 0.75rem; opacity: 0.8;">Instant start, AI opponents</div>
                </button>
                <button id="multiBtn" class="btn-blue" disabled>
                  📡 Play Online
                  <div style="font-size: 0.75rem; opacity: 0.8;">Auto-match with real players</div>
                </button>
              </div>
            </div>
          </div>
        `;
        
        const input = document.getElementById('nameInput');
        const aiBtn = document.getElementById('aiBtn');
        const multiBtn = document.getElementById('multiBtn');
        input.addEventListener('input', (e) => {
          state.playerName = e.target.value;
          aiBtn.disabled = !e.target.value.trim();
          multiBtn.disabled = !e.target.value.trim();
        });
        aiBtn.addEventListener('click', () => startSimulatedGame());
        multiBtn.addEventListener('click', () => autoMatchmaking());
      }
      
      else if (state.screen === 'lobby') {
        const playersHtml = state.players.map(p => `
          <div class="player-card">
            <div class="avatar">${p.name[0].toUpperCase()}</div>
            <span style="font-weight: 600; color: #1f2937;">${p.name}</span>
            ${p.isAI ? '<span class="badge badge-purple">AI</span>' : ''}
            ${p.id === state.myPlayerId ? '<span class="badge badge-green">You</span>' : ''}
            ${state.gameMode === 'real' && state.isHost && p.id === state.myPlayerId ? '<span class="badge" style="background: #fef08a; color: #854d0e;">Host</span>' : ''}
          </div>
        `).join('');
        
        app.innerHTML = `
          <div class="bg-gradient">
            <div class="card">
              <h2 class="text-center mb-4">${state.gameMode === 'real' ? 'Waiting Room' : 'Players Ready!'}</h2>
              ${state.gameMode === 'real' && state.roomCode && state.isHost ? `
                <div style="background: #dbeafe; border: 2px solid #3b82f6; border-radius: 0.5rem; padding: 1rem; margin-bottom: 1rem; text-align: center;">
                  <p style="font-size: 0.875rem; color: #6b7280; margin-bottom: 0.5rem;">🎮 You are the host!</p>
                  <p style="font-size: 0.875rem; color: #6b7280;">Waiting for players to join...</p>
                  <p style="font-size: 0.75rem; color: #6b7280; margin-top: 0.5rem;">Players: ${state.players.length}/4</p>
                </div>
              ` : ''}
              ${state.gameMode === 'real' && !state.isHost ? `
                <div style="background: #dcfce7; border: 2px solid #22c55e; border-radius: 0.5rem; padding: 1rem; margin-bottom: 1rem; text-align: center;">
                  <p style="font-size: 0.875rem; color: #15803d;">✅ Connected!</p>
                  <p style="font-size: 0.75rem; color: #15803d; margin-top: 0.25rem;">Waiting for host to start the game...</p>
                </div>
              ` : ''}
              <div class="mb-6">${playersHtml}</div>
              ${state.gameMode === 'real' && state.isHost ? `
                <button class="btn-blue mb-4" onclick="startRealGame()" style="background: #22c55e;">
                  🎮 Start Game (${state.players.length} ${state.players.length === 1 ? 'player' : 'players'})
                </button>
                <p style="text-align: center; font-size: 0.875rem; color: #6b7280;">Game can start with 1+ players</p>
              ` : ''}
              ${state.gameMode === 'simulated' ? `
                <div class="text-center text-gray">
                  <p class="animate-pulse">Game starting soon...</p>
                </div>
              ` : ''}
            </div>
          </div>
        `;
      }
      
      else if (state.screen === 'game') {
        const animal = ANIMALS[state.currentQuestion];
        const scoresHtml = state.players.map(p => `
          <div class="score-box">
            <div class="score-name">${p.name}</div>
            <div class="score-value">${state.scores[p.id] || 0}</div>
          </div>
        `).join('');
        
        if (!state.shuffledOptions[state.currentQuestion]) {
          state.shuffledOptions[state.currentQuestion] = getShuffledOptions(state.currentQuestion);
        }
        
        const shuffledOpts = state.shuffledOptions[state.currentQuestion];
        const optionsHtml = shuffledOpts.map((emoji, idx) => {
          let btnClass = 'emoji-btn';
          if (state.answered && emoji === state.correctAnswer) btnClass += ' emoji-correct';
          else if (state.answered && emoji !== state.correctAnswer) btnClass += ' emoji-wrong';
          return `<button class="${btnClass}" onclick="handleAnswer('${emoji}')" ${state.answered ? 'disabled' : ''}>${emoji}</button>`;
        }).join('');
        
        app.innerHTML = `
          <div class="bg-gradient">
            <div class="card card-lg">
              <div class="game-header">
                <div class="flex justify-between items-center flex-wrap mb-4">
                  <div style="font-size: 1.25rem; font-weight: bold; color: #1f2937;">Question ${state.currentQuestion + 1}/10</div>
                  <div class="flex gap-3 flex-wrap">${scoresHtml}</div>
                </div>
                <div class="sound-box">
                  <div class="flex items-center justify-center gap-3 mb-4">
                    <span style="font-size: 2rem;">🔊</span>
                    <span style="font-size: 1.5rem; font-weight: bold; color: #1f2937;">Listen to the sound!</span>
                  </div>
                  <button class="btn-blue" onclick="playSound()" style="width: auto; padding: 0.5rem 1.5rem;">🔊 Play Again</button>
                </div>
                <div class="text-center mb-4">
                  <div class="timer">⏱️ ${state.timeLeft}s</div>
                </div>
                ${state.winner ? `<div class="winner-box">🎉 ${state.winner} answered first!</div>` : ''}
              </div>
              <div class="grid">${optionsHtml}</div>
            </div>
          </div>
        `;
      }
      
      else if (state.screen === 'results') {
        const sortedPlayers = [...state.players].sort((a, b) => (state.scores[b.id] || 0) - (state.scores[a.id] || 0));
        const topPlayer = sortedPlayers[0];
        const resultsHtml = sortedPlayers.map((p, idx) => `
          <div class="result-item">
            <div class="flex items-center">
              <div class="result-rank">#${idx + 1}</div>
              <span style="font-weight: 600; color: #1f2937;">${p.name}</span>
            </div>
            <div class="result-score">${state.scores[p.id] || 0} pts</div>
          </div>
        `).join('');
        
        app.innerHTML = `
          <div class="bg-gradient">
            <div class="card">
              <div class="text-center mb-6">
                <div class="trophy mb-4">🏆</div>
                <h2 class="mb-2">Game Over!</h2>
                <p class="text-xl text-gray">Winner: ${topPlayer.name}</p>
              </div>
              <div class="mb-6">${resultsHtml}</div>
              <button class="btn-blue" onclick="resetGame()">Play Again</button>
            </div>
          </div>
        `;
      }
    }

    function startSimulatedGame() {
      if (!state.playerName.trim()) return;
      const playerId = 'player-' + Date.now();
      state.myPlayerId = playerId;
      state.gameMode = 'simulated';
      state.players = [
        { id: playerId, name: state.playerName, isAI: false },
        { id: 'ai-1', name: 'Alex', isAI: true },
        { id: 'ai-2', name: 'Jordan', isAI: true }
      ];
      state.scores = {};
      state.players.forEach(p => { state.scores[p.id] = 0; });
      state.shuffledOptions = [];
      for (let i = 0; i < ANIMALS.length; i++) {
        state.shuffledOptions[i] = getShuffledOptions(i);
      }
      state.screen = 'lobby';
      render();
      
      setTimeout(() => {
        state.screen = 'game';
        render();
        playSound();
        startTimer();
      }, 2000);
    }

    function autoMatchmaking() {
      console.log('Play Online clicked');
      
      if (!state.playerName.trim()) {
        alert('Please enter your name first!');
        return;
      }
      
      if (!database) {
        alert('Firebase is not connected. Please check your internet connection and try again.');
        console.error('Firebase database is not available');
        return;
      }
      
      console.log('Starting matchmaking for:', state.playerName);
      
      const playerId = 'player-' + Date.now();
      state.myPlayerId = playerId;
      state.gameMode = 'real';
      
      const openRoomsRef = database.ref('openRooms');
      
      openRoomsRef.orderByChild('created').limitToFirst(1).once('value', snapshot => {
        console.log('Checking for available rooms...');
        let foundRoom = false;
        
        snapshot.forEach(child => {
          const roomCode = child.key;
          const roomData = child.val();
          
          console.log('Found room:', roomCode, 'with', Object.keys(roomData.players || {}).length, 'players');
          
          const playerCount = Object.keys(roomData.players || {}).length;
          if (!roomData.started && playerCount < 4) {
            foundRoom = true;
            console.log('Joining room:', roomCode);
            joinAvailableRoom(roomCode, playerId);
          }
        });
        
        if (!foundRoom) {
          console.log('No available room found, creating new room...');
          createOpenRoom(playerId);
        }
      }).catch(error => {
        console.error('Error checking rooms:', error);
        alert('Error connecting. Please check your Firebase setup and try again.');
      });
    }

    function createOpenRoom(playerId) {
      if (!database) return;
      
      const code = generateRoomCode();
      state.roomCode = code;
      state.myPlayerId = playerId;
      state.isHost = true;
      
      const player = { id: playerId, name: state.playerName, isAI: false };
      
      const roomData = {
        host: playerId,
        players: { [playerId]: player },
        scores: { [playerId]: 0 },
        currentQuestion: 0,
        started: false,
        winner: null,
        answeredCorrectly: false,
        timeoutTriggered: false,
        created: Date.now()
      };
      
      database.ref('openRooms/' + code).set(roomData).then(() => {
        return database.ref('rooms/' + code).set(roomData);
      }).then(() => {
        console.log('Room created successfully:', code);
        state.players = [player];
        state.scores = { [playerId]: 0 };
        state.shuffledOptions = [];
        for (let i = 0; i < ANIMALS.length; i++) {
          state.shuffledOptions[i] = getShuffledOptions(i);
        }
        state.screen = 'lobby';
        render();
        listenToRoom(code);
      }).catch(error => {
        console.error('Error creating room:', error);
        alert('Error creating room. Please try again.');
      });
    }

    function joinAvailableRoom(code, playerId) {
      if (!database) return;
      
      const roomRef = database.ref('rooms/' + code);
      const openRoomRef = database.ref('openRooms/' + code);
      
      roomRef.once('value').then(snapshot => {
        if (!snapshot.exists()) {
          console.log('Room no longer exists, creating new one');
          createOpenRoom(playerId);
          return;
        }
        
        const roomData = snapshot.val();
        
        if (roomData.started) {
          console.log('Game already started, creating new room');
          createOpenRoom(playerId);
          return;
        }
        
        const playerCount = Object.keys(roomData.players || {}).length;
        if (playerCount >= 4) {
          console.log('Room is full, creating new room');
          createOpenRoom(playerId);
          return;
        }
        
        const player = { id: playerId, name: state.playerName, isAI: false };
        
        const updates = {
          [`players/${playerId}`]: player,
          [`scores/${playerId}`]: 0
        };
        
        roomRef.update(updates).then(() => {
          return openRoomRef.update(updates);
        }).then(() => {
          console.log('Joined room successfully:', code);
          state.roomCode = code;
          state.myPlayerId = playerId;
          state.isHost = false;
          state.shuffledOptions = [];
          for (let i = 0; i < ANIMALS.length; i++) {
            state.shuffledOptions[i] = getShuffledOptions(i);
          }
          state.screen = 'lobby';
          render();
          listenToRoom(code);
          
          roomRef.once('value').then(snap => {
            const data = snap.val();
            if (Object.keys(data.players || {}).length >= 4) {
              openRoomRef.remove();
            }
          });
        }).catch(error => {
          console.error('Error joining room:', error);
          createOpenRoom(playerId);
        });
      });
    }

    function listenToRoom(code) {
      if (!database) return;
      const roomRef = database.ref('rooms/' + code);
      
      roomRef.on('value', snapshot => {
        if (!snapshot.exists()) return;
        const data = snapshot.val();
        
        state.players = Object.values(data.players || {});
        state.scores = data.scores || {};
        
        if (data.started && state.screen === 'lobby') {
          state.screen = 'game';
          state.currentQuestion = data.currentQuestion || 0;
          state.timeLeft = 5;
          state.answered = false;
          if (!state.shuffledOptions.length) {
            for (let i = 0; i < ANIMALS.length; i++) {
              state.shuffledOptions[i] = getShuffledOptions(i);
            }
          }
          render();
          playSound();
          startLocalTimer();
        }
        
        if (data.currentQuestion !== state.currentQuestion && state.screen === 'game') {
          if (state.timer) clearInterval(state.timer);
          state.currentQuestion = data.currentQuestion;
          state.timeLeft = 5;
          state.answered = false;
          state.correctAnswer = null;
          state.winner = null;
          if (!state.shuffledOptions[state.currentQuestion]) {
            state.shuffledOptions[state.currentQuestion] = getShuffledOptions(state.currentQuestion);
          }
          render();
          playSound();
          startLocalTimer();
        }
        
        if (data.winner && state.screen === 'game' && !state.answered) {
          if (state.timer) clearInterval(state.timer);
          state.winner = data.winner;
          state.answered = true;
          state.correctAnswer = ANIMALS[state.currentQuestion || 0].emoji;
          render();
        }
        
        if (data.ended && state.screen !== 'results') {
          if (state.timer) clearInterval(state.timer);
          state.screen = 'results';
          render();
        }
        
        if (state.screen === 'lobby') render();
      });
    }

    function startRealGame() {
      if (!database) return;
      
      if (state.roomCode) {
        database.ref('openRooms/' + state.roomCode).remove();
      }
      
      database.ref('rooms/' + state.roomCode).update({ started: true, currentQuestion: 0 });
    }

    function playSound() {
      const animal = ANIMALS[state.currentQuestion];
      const audio = new Audio();
      audio.src = animal.sound;
      
      audio.addEventListener('error', (e) => {
        console.log('Audio file not found, using text-to-speech');
        const utterance = new SpeechSynthesisUtterance(animal.name);
        utterance.rate = 0.8;
        utterance.pitch = 0.8;
        speechSynthesis.speak(utterance);
      });
      
      audio.play().catch(error => {
        console.log('Play error, using text-to-speech');
        const utterance = new SpeechSynthesisUtterance(animal.name);
        utterance.rate = 0.8;
        utterance.pitch = 0.8;
        speechSynthesis.speak(utterance);
      });
    }

    function startTimer() {
      if (state.timer) clearInterval(state.timer);
      state.timer = setInterval(() => {
        state.timeLeft--;
        render();
        if (state.timeLeft <= 0) {
          clearInterval(state.timer);
          handleTimeout();
        }
      }, 1000);
    }

    function startLocalTimer() {
      if (state.timer) clearInterval(state.timer);
      
      state.timer = setInterval(() => {
        state.timeLeft--;
        render();
        
        if (state.timeLeft <= 0) {
          clearInterval(state.timer);
          
          if (state.gameMode === 'real' && database) {
            handleMultiplayerTimeout();
          } else {
            handleTimeout();
          }
        }
      }, 1000);
    }

    function handleTimeout() {
      const aiAnswered = state.players.find(p => p.isAI && Math.random() > 0.3);
      if (aiAnswered) {
        state.scores[aiAnswered.id]++;
        state.winner = aiAnswered.name;
      }
      state.answered = true;
      state.correctAnswer = ANIMALS[state.currentQuestion].emoji;
      render();
      setTimeout(nextQuestion, 2000);
    }

    function handleMultiplayerTimeout() {
      if (!database || state.answered) return;
      
      state.answered = true;
      state.correctAnswer = ANIMALS[state.currentQuestion].emoji;
      render();
      
      const roomRef = database.ref('rooms/' + state.roomCode);
      
      roomRef.transaction(function(room) {
        if (!room || room.currentQuestion !== state.currentQuestion) {
          return;
        }
        
        if (!room.timeoutTriggered) {
          room.timeoutTriggered = true;
          return room;
        }
        return;
      }, function(error, committed, snapshot) {
        if (error || !committed) return;
        
        setTimeout(() => {
          roomRef.once('value').then(snap => {
            const currentData = snap.val();
            if (!currentData || currentData.currentQuestion !== state.currentQuestion) return;
            
            if (state.currentQuestion < ANIMALS.length - 1) {
              roomRef.update({ 
                currentQuestion: state.currentQuestion + 1, 
                winner: null,
                winnerId: null,
                answeredCorrectly: false,
                timeoutTriggered: false
              });
            } else {
              roomRef.update({ ended: true });
            }
          });
        }, 1500);
      });
    }

    function handleAnswer(emoji) {
      if (state.answered) return;
      if (state.timer) clearInterval(state.timer);
      
      const animal = ANIMALS[state.currentQuestion];
      const isCorrect = emoji === animal.emoji;
      
      if (state.gameMode === 'real' && database) {
        const roomRef = database.ref('rooms/' + state.roomCode);
        
        roomRef.transaction(function(room) {
          if (!room) return room;
          if (room.winner) return;
          
          if (isCorrect) {
            room.winner = state.playerName;
            room.winnerId = state.myPlayerId;
            room.scores = room.scores || {};
            room.scores[state.myPlayerId] = (room.scores[state.myPlayerId] || 0) + 1;
            room.answeredCorrectly = true;
          }
          
          return room;
        }, function(error, committed, snapshot) {
          if (error) {
            console.error('Transaction error:', error);
            return;
          }
          
          const data = snapshot.val();
          state.answered = true;
          state.correctAnswer = animal.emoji;
          
          if (committed && isCorrect) {
            state.winner = state.playerName;
            state.scores = data.scores;
          }
          
          render();
          
          if (committed && isCorrect) {
            setTimeout(() => {
              roomRef.once('value').then(snap => {
                const currentData = snap.val();
                if (!currentData || currentData.currentQuestion !== state.currentQuestion) return;
                
                if (state.currentQuestion < ANIMALS.length - 1) {
                  roomRef.update({ 
                    currentQuestion: state.currentQuestion + 1, 
                    winner: null,
                    winnerId: null,
                    timeLeft: 5,
                    answeredCorrectly: false,
                    timeoutTriggered: false
                  });
                } else {
                  roomRef.update({ ended: true });
                }
              });
            }, 2000);
          }
        });
      } else {
        state.answered = true;
        state.correctAnswer = animal.emoji;
        
        if (isCorrect) {
          state.scores[state.myPlayerId]++;
          state.winner = state.playerName;
        } else {
          const aiWinner = state.players.find(p => p.isAI);
          if (aiWinner) {
            state.scores[aiWinner.id]++;
            state.winner = aiWinner.name;
          }
        }
        render();
        setTimeout(nextQuestion, 2000);
      }
    }

    function nextQuestion() {
      if (state.currentQuestion < ANIMALS.length - 1) {
        state.currentQuestion++;
        state.timeLeft = 5;
        state.answered = false;
        state.correctAnswer = null;
        state.winner = null;
        if (!state.shuffledOptions[state.currentQuestion]) {
          state.shuffledOptions[state.currentQuestion] = getShuffledOptions(state.currentQuestion);
        }
        render();
        playSound();
        startTimer();
      } else {
        state.screen = 'results';
        render();
      }
    }

    function resetGame() {
      if (state.timer) clearInterval(state.timer);
      if (state.gameMode === 'real' && state.isHost && state.roomCode && database) {
        database.ref('rooms/' + state.roomCode).remove();
        database.ref('openRooms/' + state.roomCode).remove();
      }
      state = {
        screen: 'menu',
        gameMode: null,
        playerName: '',
        players: [],
        currentQuestion: 0,
        timeLeft: 5,
        scores: {},
        answered: false,
        correctAnswer: null,
        winner: null,
        myPlayerId: '',
        timer: null,
        roomCode: '',
        isHost: false,
        shuffledOptions: []
      };
      render();
    }

    render();
  </script>
</body>
</html>
